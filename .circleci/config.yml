# Use the latest 2.1 version of CircleCI pipeline process engine.
version: 2.1

commands:
  install_awscli:
    description: Install AWS CLI v2
    steps:
      - run:
          name: Install AWS CLI v2
          command: |
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install

  destroy-environment:
    description: Destroy back-end and front-end cloudformation stacks given a workflow ID.
    parameters:
      Workflow_ID:
        type: string
        default: ${CIRCLE_WORKFLOW_ID:0:7}
    steps:
      - run:
          name: Destroy environments
          when: on_fail
          command: |
            aws cloudformation delete-stack --stack-name udapeople-backend-<< parameters.Workflow_ID >>
            aws s3 rm s3://udapeople-<<parameters.Workflow_ID>> --recursive
            aws cloudformation delete-stack --stack-name udapeople-frontend-<< parameters.Workflow_ID >>

jobs: 
  Build:

    docker:
      - image: cimg/aws:2023.06

    steps:
      - checkout
      - restore_cache:
          keys: [httpdAppBuild]
          
      - run:
          name: install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install nginx
            
      - run:
          name: Build httpd app
          command: |
            #cd httpd
            #httpd main.py --host 0.0.0.0 --port 8000
            #httpd main.py
            #nohup httpd3 httpd/main.py > output.log &
            #nohup sh -c 'cd /httpd/main.py && source venv/bin/activate && gunicorn wsgi:app -b localhost:8000' &

            #cd httpd
            #source venv/bin/activate
            #gunicorn wsgi:app -c gunicorn_config.py
            #nohup sh -c 'cd /path/to/flask/app && source venv/bin/activate && gunicorn wsgi:app -c gunicorn_config.py' &
            #nohup sh -c 'cd httpd && gunicorn wsgi:app -c gunicorn_config.py' &


      - run:
          name: Test httpd Application
          command: |
            mkdir -p workspace
            curl http://localhost:8080 > workspace/httpd_WebApp.html

      - persist_to_workspace:
          root: workspace
          paths:
            - httpd_WebApp.html

      - save_cache:
          paths: [httpd/save_cache]
          key: httpdAppBuild

  Test:
    docker:
      - image: cimg/aws:2023.06

    steps:

      - checkout

      - restore_cache:
          keys: [httpdAppBuild]
      
      - attach_workspace:
          at: /tmp/workspace

      - run:
          name: Test httpd app
          command: cat /tmp/workspace/httpd_WebApp.html
################################################################
#  Scan:
#    docker:
#      - image: cimg/httpd:3.11.4
#    steps:
#      - checkout
#      - restore_cache:
#          keys: [httpdAppBuild]
#      - run:
#          name: Scan httpd app
#          command: |
#            httpd --version
#            cd httpd
#            httpd main_scan.py

  Deploy-infrastructure:  # Job Name
    docker:
      - image: cimg/aws:2023.05  # Spcecify The AWS image.

    steps:  # Job Steps
      - checkout  # checkout code from GitHub
      - restore_cache:
          keys: [httpdAppBuild]
      - run: pwd
      - run:
          name: Build ec2 instance
          command: |
            aws cloudformation deploy \
              --template-file CloudFormation/cloudformation.yml \
              --tags project=circleci \
              --stack-name "Circleci-${CIRCLE_WORKFLOW_ID:0:7}" \
              --parameter-overrides ID="${CIRCLE_WORKFLOW_ID:0:7}"

            aws cloudformation wait stack-create-complete \
            --stack-name "Circleci-${CIRCLE_WORKFLOW_ID:0:7}"

            aws cloudformation describe-stacks \
            --stack-name "Circleci-${CIRCLE_WORKFLOW_ID:0:7}" \
            --query 'Stacks[0].Outputs[?OutputKey==`PublicIp`].OutputValue' \
            --output text
      - run:
          name: Print faild events
          when: on_fail
          command: |
            aws cloudformation describe-stack-events --stack-name "Circleci-${CIRCLE_WORKFLOW_ID:0:7}"


  Build-httpd-app:  # Job Name
    docker:
      - image: cimg/aws:2023.05  # Spcecify The AWS image.

    steps:  # Job Steps
      - checkout  # checkout code from GitHub
      - restore_cache:
          keys: [httpdAppBuild]

      - run:
          name: Wait for the stack to be created
          command: |
            aws cloudformation wait stack-create-complete \
            --stack-name "Circleci-${CIRCLE_WORKFLOW_ID:0:7}"

      - run:
          name: Fetch the ec2 Pub IP
          command: |
            aws cloudformation describe-stacks \
            --stack-name "Circleci-${CIRCLE_WORKFLOW_ID:0:7}" \
            --query 'Stacks[0].Outputs[?OutputKey==`PublicIp`].OutputValue' \
            --output text
            pwd
            
      - run: ls -lh; cat text

      - run:
          name: SSH & Build httpd app
          command: |
            public_ip=$(cat text)
            echo "$public_ip"

            aws ec2 describe-key-pairs \
            --key-name ec2_01 \
            --query 'KeyPairs[0].KeyMaterial' \
            --output text > ~/.ssh/	ec2_01.pem
            chmod 400 ~/.ssh/ec2_01.pem

            ssh -i ~/.ssh/ec2_01.pem ec2-user@$public_ip 'ls -la /tmp'
            # fetch httpd script for build
            # run

  Test-httpd-app:  # Job Name
    docker:
      - image: cimg/aws:2023.05  # Spcecify The AWS image.

    steps:  # Job Steps
      - checkout  # checkout code from GitHub
      - restore_cache:
          keys: [httpdAppBuild]
      - run: pwd
      - run:
          name: Build httpd app
          command: |
            # ssh
            # fetch httpd script for test
            # run

  Scan-httpd-app:  # Job Name
    docker:
      - image: cimg/aws:2023.05  # Spcecify The AWS image.

    steps:  # Job Steps
      - checkout  # checkout code from GitHub
      - restore_cache:
          keys: [httpdAppBuild]
      - run: pwd
      - run:
          name: Build httpd app
          command: |
            # ssh
            # fetch httpd script for scan
            # run

workflows:
  httpd_App:
    jobs:
      - Build
      - Test:
          requires: [Build]
      #- Scan:
      #    requires: [Build]
#
      #- Deploy-infrastructure:
      #    requires: [Test, Scan]
#
      #- Build-httpd-app:
      #    requires: [Deploy-infrastructure]
      #- Test-httpd-app:
      #    requires: [Build-httpd-app]
      #- Scan-httpd-app:
      #    requires: [Build-httpd-app]


